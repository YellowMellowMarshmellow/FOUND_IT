<!DOCTYPE html>
<html>
  <head>
    <title>FoundIt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <!-- in app/views/layouts/application.html.erb -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js'></script>
    <%= javascript_importmap_tags %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  </head>

  <body>
    <nav class="navbar navbar-light bg-light">
      <div class="container main-bg">
        <a class="navbar-brand" href="/">
          <img src="<%= asset_path('found_it_logo.svg') %>" width="30" height="30" class="d-inline-block align-top" alt="Logo">
          Found It
        </a>

        <% if user_signed_in? %>
          <div class="d-flex align-items-center ms-auto">
            <span class="navbar-text me-3"><%= current_user.first_name %></span>

            <!-- Cloche + dropdown -->
            <div class="position-relative me-3">
              <button id="notification-bell" type="button" class="btn position-relative">
                <i class="bi bi-bell"></i>
                <% if @unread_notifications_count.to_i > 0 %>
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    <%= @unread_notifications_count %>
                  </span>
                <% end %>
              </button>

              <!-- Dropdown notifications -->
              <div id="notification-dropdown"
                  class="dropdown-menu dropdown-menu-end p-2 shadow"
                  style="display: block; position: absolute; top: 100%; right: 0; width: 400px !important; background: white; border: 1px solid #ccc;">
                <ul class="list-unstyled mb-0">
                  <% @notifications.each do |notification| %>
                    <% if notification.notifiable.present? %>
                    <li class="mb-2 p-2 <%= 'fw-bold' unless notification.read %> position-relative">
                      <%= link_to polymorphic_path(notification.notifiable),
                          class: "text-decoration-none text-dark d-block w-100 h-100" do %>
                          <div><%= notification.message %></div>
                        <% end %>

                        <% unless notification.read %>
                          <div class="d-flex justify-content-between small text-muted">
                            <%= link_to "Mark as read",
                                mark_as_read_notification_path(notification),
                                method: :patch,
                                remote: true,
                                onclick: "event.stopPropagation();" %>
                          </div>
                        <% end %>
                      </li>
                    <% else %>
                      <li class="mb-2 p-2 <%= 'fw-bold' unless notification.read %>">
                        <div><%= notification.message %></div>
                      </li>
                    <% end %>
                  <% end %>
                </ul>
              </div>
            </div>

            <!-- Log out -->
            <%= button_to "Log out",
                destroy_user_session_path,
                method: :delete,
                class: "btn btn-outline-secondary btn-sm" %>
          </div>


        <% else %>
          <%= link_to "Log in", new_user_session_path, class: "btn btn-outline-primary btn-sm" %>
        <% end %>
      </div>
    </nav>
    <% flash.each do |key, message| %>
      <div class="alert alert-<%= key == 'notice' ? 'success' : 'danger' %>">
        <%= message %>
      </div>
    <% end %>

    <p class="notice"><%= notice %></p>
    <p class="alert"><%= alert %></p>
    <%= yield %>
    <%= render "shared/footer" %>
  </body>
</html>
